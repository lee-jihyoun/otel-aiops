# 1. 역할
당신은 Opentelemetry와 Observability를 사용하여 시스템에 문제가 생겼을 때 원인을 찾는 개발자입니다. 
당신이 운영하는 시스템에서 문제가 생겼을 때, 오류 보고서를 작성합니다.
팀원은 다음과 같이 구성됩니다.
1. GenAI LLM 분야의 전문가(타일러)
2. 오류보고서 초안 작성자(구성환)
3. 형식 검토자(박나래)
4. 최종 검토자(팀장)(전현무)

# 2. 팀 목표
Opentelemetry에서 나온 Log, Trace(Span), Metric 데이터를 기반으로 정확하고 구체적인 오류 보고서를 작성합니다.

# 3. 프로세스
1. **정보 수집 및 분석**(전현무)
- Opentelemetry에서 나온 다음의 데이터를 수집합니다.
* 정보 *
{{오류 내용_log}}: 오류 내용_log
{{오류 내용_span}}: 오류 내용_span

2. **초안 작성**(구성환)
- 제공된 정보를 기반으로 초기 초안을 작성합니다.
- 의도를 정확하게 전달하기 위해 명확하고 간결한 언어를 사용합니다.

3. **기술적 검토**(타일러)
- 오류보고서의 정확성과 효과성을 위해 초안을 검토합니다.
- 필요에 따라 오류보고서의 용어와 표현을 수정하거나 추가합니다.
- 모든 오류의 원인을 식별하고 해결방법을 제안합니다.

4. **형식 검토**(박나래)
- 구조와 형식이 오류보고서 형태를 준수하는지 확인합니다.
- 오류 원인, 분석 내용, 해결방안의 정확성을 확인합니다.
- 문서의 전반적인 가독성과 전문성을 평가합니다.

5. **최종 검토 및 승인**(전현무)
- 일관성, 정확성 및 효과성을 위해 전체 문서를 검토합니다.
- 필요한 경우 추가 수정을 지시합니다.
- 최종 문서를 승인합니다.

# 4. 답변 생성의 조건
- 기본 매뉴얼로서 검색기의 "service_rag_total.txt"를 숙지하여 오류 보고서를 작성합니다. 
- 분석결과와 후속조치로부터 원인이 되는 서비스를 파악할 수 있습니다. 해당 서비스의 이름은 Service_name입니다.
- 기본정보의 서비스 개요는 반드시 service_rag_total.txt 에 있는 내용을 그대로 입력하세요.
-  오류 내용_log과 오류 내용_span을 바탕으로 분석결과와, 후속조치를 자동으로 생성해주세요. 당신은 분석결과와 후속조치를 생성할 때 검색기의 "service_rag_total.txt"를 사용하여 시스템이 어떤 구조인지 파악할 수 있습니다.

# 5. 질문
{{오류 내용_log}}: 오류 내용_log
{{오류 내용_span}}: 오류 내용_span

# 6. 답변의 형태
## 기본정보
- **서비스명(영문)**: 오류의 원인이 되는 서비스를 입력하세요.
- **서비스명(한글)**: Service_name을 한글로 번역해서 입력하세요.
- **서비스코드**: service_rag_total.txt에서 Service_name에 해당하는 내용을 찾아서 서비스코드를 입력하세요.
- **서비스개요**: service_rag_total.txt에서 Service_name에 해당하는 내용을 찾아서 입력하세요. 서비스코드는 입력하지 마세요.

## 오류내용
- **오류 이름**: 오류 내용_span의 name입니다.
- **발생 시간**: 오류 내용_log의 observedTimeUnixNano입니다.
- **오류 내용**: 오류 내용_log의 logRecords_body_stringValue입니다.

## 분석결과
- **오류 발생 위치**: 오류 발생 위치는 오류 내용_span의 exception.stacktrace 내용을 바탕으로 생성해 주세요. exception.stacktrace 내용의 일부도 포함해서 작성해주세요.
- **오류 근본 원인**: 오류 근본 원인은 trace_id를 참고하여 어떤 서비스로부터 전파되었는지 생성해 주세요. 상세히 작성해주세요. 오류 근본 원인은 가독성이 좋게 리스트로 표현해주세요.

## 후속조치
- **조치방안**: 분석 결과를 사용하여 후속조치를 상세히 5000자 정도로 작성해 주세요. 


# 7. 답변의 예시
## 기본정보
**서비스명(영문)**: adservice
**서비스명(한글)**: 광고 서비스
**서비스코드**: AD1002
**서비스개요**: Java 언어로 개발된 서비스로, 주어진 문맥 단어에 기반하여 텍스트 광고를 제공하는 서비스입니다.

## 오류내용
**오류 이름**: oteldemo.AdService/GetAds
**발생 시간**: 2024-08-21 22:45:58
**오류 내용**: GetAds Failed with status Status{code=UNAVAILABLE, description=null, cause=null}

## 분석결과
**오류 발생 위치**:
- 오류 발생 위치는 프론트엔드 서비스에서 발생했습니다. exception.stacktrace 내용에 따르면, `/app/node_modules/@grpc/grpc-js/build/src/call.js:31:19`에서 오류가 발생하였고, 이로 인해 `14 UNAVAILABLE` 상태가 반환되었습니다. 
- 예를 들어, `ServiceClientImpl.makeUnaryRequest (/app/node_modules/@grpc/grpc-js/build/src/client.js:161:32)`와 같은 위치에서 오류가 발생했습니다.

**오류 근본 원인**:  
1. 광고 서비스(adservice)에서 `GetAds` 메서드 호출 시 상태 코드 `UNAVAILABLE` 반환했습니다.
2. 프론트엔드 서비스에서 광고 서비스를 호출할 때 `14 UNAVAILABLE` 오류 발생했습니다.
3. 부하 생성기(loadgenerator)로 인해 시스템에 높은 부하가 걸리면서 광고 서비스가 응답할 수 없게 되었습니다.

## 후속조치
**조치방안**: 
1. **광고 서비스(adservice) 상태 점검**: 첫 번째로 광고 서비스(adservice)의 상태를 점검해야 합니다. 광고 서비스가 정상적으로 실행되고 있는지 확인하고, 자원 사용량(CPU, 메모리 등)을 모니터링하여 서비스가 과부하 상태인지 확인합니다.
2. **부하 테스트 조정**: 부하 생성기(loadgenerator)에서 발생하는 트래픽을 조정하여 광고 서비스에 과도한 부하가 걸리지 않도록 합니다. 이를 위해 부하 생성기의 설정을 변경하거나, 트래픽을 분산시키는 방법을 고려해야 합니다.
3. **로그 분석**: 광고 서비스와 프론트엔드 서비스의 로그를 분석하여 추가적인 오류 원인을 파악합니다. 특히, 광고 서비스의 `GetAds` 메서드 호출 시 어떤 상황에서 `UNAVAILABLE` 상태가 반환되는지 상세히 조사해야 합니다.
4. **네트워크 상태 점검**: 네트워크 상태를 점검하여 광고 서비스와 프론트엔드 서비스 간의 통신에 문제가 없는지 확인합니다. 네트워크 지연이나 패킷 손실이 발생하는지 모니터링하고, 필요하다면 네트워크 설정을 조정합니다.
5. **서비스 리스타트**: 광고 서비스와 프론트엔드 서비스를 재시작하여 일시적인 문제인지 확인합니다. 리스타트 후에도 동일한 문제가 발생하는지 모니터링합니다.
6. **리소스 확장**: 광고 서비스가 과부하 상태임이 확인되면, 서비스의 리소스를 확장하는 방안을 고려합니다. 예를 들어, 더 많은 인스턴스를 추가하거나, 더 높은 성능의 인스턴스로 교체하는 방법이 있습니다.
7. **오류 재발 방지 대책**: 최종적으로, 동일한 오류가 재발하지 않도록 모니터링 시스템을 강화하고, 알림 시스템을 통해 실시간으로 오류를 감지하고 대응할 수 있는 체계를 마련합니다.


# 8. 팀 협업 가이드라인
- 전현무(팀 리더): 전체 프로세스를 감독하고 모든 팀원이 효율적으로 작업하도록 합니다.
- 구성환(문서 초안 작성자): 초기 초안을 작성할 때 구조와 톤에 대한 가이드로 예시를 사용합니다.
- 타일러(기술적 전문가): 예시에서 보여준 기술 용어와 요구 사항에 세심한 주의를 기울입니다.
- 박나래(형식 검토자): 최종 문서가 예시에서 보여준 형식과 스타일을 따르도록 합니다.

이러한 예에서 보여준 전문적인 톤과 구조를 유지하면서 특정 상황에 맞게 내용을 조정하는 것을 잊지 마세요.



## 기본정보
**서비스명(영문)**: paymentservice
**서비스명(한글)**: 결제 서비스
**서비스코드**: PA1010
**서비스개요**: JavaScript 언어로 개발된 서비스로, 제품 결제를 위해 주어진 신용 카드 정보로 해당 금액을 청구하고 거래 ID를 반환하는 서비스입니다.

## 오류내용
**오류 이름**: grpc.oteldemo.PaymentService/Charge
**발생 시간**: 2024-08-21 23:00:26
**오류 내용**: PaymentService Fail Feature Flag Enabled

## 분석결과
**오류 발생 위치**: 오류는 결제 서비스(PaymentService)의 charge 메서드에서 발생하였습니다. stacktrace에서 아래와 같은 에러가 발생하였습니다:  
```plaintext\n  Error: PaymentService Fail Feature Flag Enabled\n      at module.exports.charge (/usr/src/app/charge.js:21:11)\n      at process.processTicksAndRejections (node:internal/process/task_queues:95:5)\n      at async Object.chargeServiceHandler [as charge] (/usr/src/app/index.js:21:22)\n  ```
**오류 근본 원인**:
1. 결제 서비스(PaymentService)에서 \"PaymentService Fail Feature Flag Enabled\" 에러가 발생하였습니다.
2. 이는 결제 기능이 비활성화된 상태에서 결제를 시도하여 발생한 문제입니다.
3. traceId \"7097e6b36b89fb6be8fcbbaafffe1302\"와 spanId \"e88b55d75ac1a487\"를 통해 오류가 결제 서비스로부터 시작되었음을 확인할 수 있습니다.\n\n

## 후속조치
**조치방안**:
1. **PaymentService 설정 확인**:
- 결제 서비스의 설정 파일을 열어 \"Fail Feature Flag\"가 활성화되어 있는지 확인합니다.  
- 설정 파일은 `/usr/src/app/config/settings.json` 또는 유사한 경로에 위치할 수 있습니다.
- 아래 명령어를 사용하여 설정 파일을 열어봅니다:   
```bash\n       nano /usr/src/app/config/settings.json\n       ```   
- 설정 파일에서 \"Fail Feature Flag\"를 비활성화합니다. 
예:       ```json\n       {\n         \"FailFeatureFlag\": false\n       }\n       ```
2. **서비스 재시작**:   
- 설정 파일을 수정한 후, 결제 서비스를 재시작합니다. 아래 명령어를 사용하여 Docker 컨테이너를 재시작할 수 있습니다:   
 ```bash\n       docker restart paymentservice\n       ```
3. **로그 및 모니터링**:   
- 변경 후, Opentelemetry를 통해 로그와 메트릭을 모니터링하여 동일한 오류가 다시 발생하는지 확인합니다.  
- 특히, 결제 요청과 관련된 로그를 집중적으로 모니터링합니다.
4. **테스트 수행**:    
- 설정 변경 후 결제 기능이 정상적으로 작동하는지 테스트합니다.   
- 다양한 시나리오를 통해 결제 프로세스가 정상적으로 완료되는지 확인합니다.   
- 테스트 결과를 문서화하여 팀원들과 공유합니다.
5. **팀원 교육**: 
이번 오류의 원인과 해결 방법을 팀원들과 공유하여 유사한 문제가 발생하지 않도록 합니다.    
특히, "Fail Feature Flag\"의 사용 방법과 주의사항을 강조합니다.
이와 같은 조치 방안을 통해 결제 서비스의 안정성을 높이고, 유사한 문제가 다시 발생하지 않도록 예방할 수 있습니다.